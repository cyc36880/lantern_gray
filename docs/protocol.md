## 概述

本模块为集成超声波测距与RGB颜色控制功能的复合传感器，支持通过I²C接口进行通信。兼容M5系列开发板（可直接调用基础功能，但需自定义I²C指令实现颜色控制），需严格遵循协议规范以确保通信稳定性与数据准确性。



------

## 核心特性与注意事项

###  兼容性与限制

- **M5兼容性**：可直接在M5设备上调用基础功能（如读取距离），但**不支持通过M5内置模块直接设置探头颜色**，需用户自行编写I²C指令控制颜色参数。
- **读取频率限制**：连续读取操作间隔需 **≥50ms**，过高的读取频率将导致返回数据异常（因传感器内部处理延迟）。
- **上电默认状态**：模块上电且未执行任何写入操作时，默认显示 **蓝色**（RGB颜色控制初始值）。



------

## 设备基础信息

### I²C设备地址

固定为 **0x57**（7位地址格式，无需额外移位操作）。



------

## 功能操作协议

### RGB颜色设置（指令ID: 0x02）

#### 功能描述

通过I²C指令动态调整模块集成LED探头的RGB颜色及亮度。

#### 操作流程

1. **发送命令字节**：首先向模块写入 **1字节命令** `0x02`（标识颜色设置指令）。
2. **发送颜色参数**：紧随其后，按顺序写入 **4字节参数**，具体定义如下：

| 字节序  | 参数名称     | 取值范围 | 说明                                |
| ------- | ------------ | -------- | ----------------------------------- |
| 第1字节 | 亮度         | 0~255    | 控制RGB整体亮度（0为灭，255为最亮） |
| 第2字节 | 红色分量 (R) | 0~255    | 红色通道强度                        |
| 第3字节 | 绿色分量 (G) | 0~255    | 绿色通道强度                        |
| 第4字节 | 蓝色分量 (B) | 0~255    | 蓝色通道强度                        |

> **参数顺序**：亮度 → R → G → B（共4字节，需连续写入）。



------

### 距离读取（指令ID: 0x01）

#### 功能描述

获取模块通过超声波测距功能计算的当前目标距离值（单位：厘米）。

#### 操作流程

1. **发送命令字节**（兼容性要求）：写入 **1字节命令** `0x01`（标识距离读取指令）。*（注：该步骤仅为兼容M5开发板设计，实际独立使用时可省略）*

2. **读取返回数据**：从模块读取 **3字节原始数据**（依次为Byte0、Byte1、Byte2）。

3. **计算实际距离**：通过以下公式转换原始数据为厘米单位：

   ```
   distance (cm) = ( (Byte0 << 16) | (Byte1 << 8) | Byte2 ) / 10000.0
   ```

   - **计算逻辑**：将3字节合并为24位整型数值后，除以10000得到厘米值。

> **关键要求**：两次距离读取操作的时间间隔必须 **>50ms**，否则可能因传感器处理未完成导致数据错误。



---

### IAP升级（指令ID: 0x03）

#### 功能描述

通过I²C指令触发设备升级模式，需配合后续串口通信完成固件更新（适用于功能扩展或问题修复场景）。

#### 操作流程

1. **发送升级指令**：向模块写入 **1字节命令 `0x03`**（标记设备进入待升级状态）。
2. **重启设备**：重新给模块上电（或软复位）。
3. **切换通信模式**：上电后，模块的 **SCL 引脚转为 TX（串口发送），SDA 引脚转为 RX（串口接收）**，需通过 **CH340 等USB转串口工具** 连接至电脑。
4. **发送升级包**：使用 **XMODEM协议** 通过串口（波特率 **115200**）上传固件升级包。

#### 升级失败处理

- 若出现以下情况，升级将失败并回退至上一版本：升级等待超时（>300秒未完成传输）；升级过程中断开连接（如拔掉串口线）；重置设备（主动断电或复位）。
- **版本恢复机制**：无论升级是否成功，在 **第二次上电时**，设备将自动清除升级标志，直接进入主程序运行。



------

## 协议使用约束

1. **写入规范**：所有指令（颜色设置/距离读取触发）均通过 **单字节命令** 触发，且每次I²C写入仅允许发送 **1字节**；连续写入多字节时需严格按功能协议顺序执行（如颜色设置需先写命令再写4字节参数）。
2. **读取规范**：距离读取需严格遵循“先写命令→后读3字节”的流程，且需自行实现24位数据的合并与单位换算。
3. **稳定性要求**：因传感器内部状态切换存在延迟，设置指令后建议增加 **适当延时**（如50~100ms）再执行读取操作，避免因模式未就绪导致数据异常。



------

*（协议设计兼顾M5生态兼容性与独立开发灵活性，用户可根据实际硬件平台调整实现细节，但需严格遵守通信时序与数据格式要求。）*
